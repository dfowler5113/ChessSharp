
@page "/chessboard"

<div class="chessboard">
    @for (int row = 0; row < 8; row++)
    {
        <div class="chessboard-row">
            @for (int col = 0; col < 8; col++)
            {
                var localRow = row;
                var localCol = col;
                <div class="@GetClasses(localRow, localCol)"  @onclick="(() => HandleClick(localRow, localCol))">
                </div>
            }
        </div>
    }
</div>

@code { 
  
    private string[,] chessPieces = new string[8, 8];
    private bool isPieceSelected = false;
    private (int row, int col) selectedPiece = (-1, -1); // Updated to track selected piece
    protected override void OnInitialized()
    {
        
        // Clear the board
        for (int i = 0; i < 8; i++)
        {
            for (int j = 0; j < 8; j++)
            {
               chessPieces[i, j] = null;
            }
        }
    
       
       

// Place the white pieces
chessPieces[0, 0] = "white-rook";
chessPieces[0, 1] = "white-knight";
chessPieces[0, 2] = "white-bishop";
chessPieces[0, 3] = "white-queen"; 
chessPieces[0, 4] = "white-king";
chessPieces[0, 5] = "white-bishop";
chessPieces[0, 6] = "white-knight";
chessPieces[0, 7] = "white-rook";
chessPieces[1, 0] = "white-pawn"; 
chessPieces[1, 1] = "white-pawn"; 
chessPieces[1, 2] = "white-pawn"; 
chessPieces[1, 3] = "white-pawn"; 
chessPieces[1, 4] = "white-pawn"; 
chessPieces[1, 5] = "white-pawn"; 
chessPieces[1, 6] = "white-pawn"; 
chessPieces[1, 7] = "white-pawn"; 


// Place the black pieces
chessPieces[7, 0] = "black-rook";
chessPieces[7, 1] = "black-knight";
chessPieces[7, 2] = "black-bishop";
chessPieces[7, 3] = "black-queen"; 
chessPieces[7, 4] = "black-king";
chessPieces[7, 5] = "black-bishop";
chessPieces[7, 6] = "black-knight";
chessPieces[7, 7] = "black-rook";
chessPieces[6, 0] = "black-pawn";
chessPieces[6, 1] = "black-pawn";
chessPieces[6, 2] = "black-pawn"; 
chessPieces[6, 3] = "black-pawn";
chessPieces[6, 4] = "black-pawn";
chessPieces[6, 5] = "black-pawn"; 
chessPieces[6, 6] = "black-pawn"; 
chessPieces[6, 7] = "black-pawn"; 


    }
private void HandleClick(int row, int col)
{
    Console.WriteLine("Clicked");
    Console.WriteLine("row and int:" + row +","+ col);
    // Check if the clicked cell has a piece
    bool cellHasPiece = chessPieces[row, col] != null;

    if (!isPieceSelected && cellHasPiece)
    {
        Console.WriteLine("Selecting piece");
        // Select the piece if no piece was previously selected and the cell isn't empty
        isPieceSelected = true;
        selectedPiece = (row, col);
    }
    else if (isPieceSelected)
    {
        if ((selectedPiece.row == row && selectedPiece.col == col) || !cellHasPiece)
        {
            Console.WriteLine("Deselecting or moving piece");
            // Deselect the piece if the same piece is clicked again or attempt to move if the destination is empty
            if (selectedPiece.row == row && selectedPiece.col == col)
            {
                // Deselect the piece
                isPieceSelected = false;
                selectedPiece = (-1, -1);
            }
            else if (!cellHasPiece)
            {
                // Attempt to move the piece if another empty cell is clicked while a piece is selected
                MovePiece(selectedPiece.row, selectedPiece.col, row, col);
                isPieceSelected = false;
                selectedPiece = (-1, -1); // Deselect after moving
            }
        }
        else if (cellHasPiece)
        {
            Console.WriteLine("Attempting to capture or switch selection");
            
            selectedPiece = (row, col); // Switch the selected piece without moving
            
        }
    }
   
    
}


    private void MovePiece(int fromRow, int fromCol, int toRow, int toCol)
    {
       
        chessPieces[toRow, toCol] = chessPieces[fromRow, fromCol];
        chessPieces[fromRow, fromCol] = null;

        // Trigger UI refresh
        StateHasChanged();
    }
    private string GetCellColor(int row, int col)
    {
      
        return (row + col) % 2 == 0 ? "light-cell" : "dark-cell";
    }

    private string GetPiece(int row, int col)
    {
        
        return chessPieces[row, col];
    }

    private string GetClasses(int row, int col)
    {
        var classes = $"chessboard-cell {GetCellColor(row, col)}";
        if (!string.IsNullOrEmpty(chessPieces[row, col]))
        {
            classes += $" {chessPieces[row, col]} chess-piece";
        }
        if (isPieceSelected && selectedPiece.row == row && selectedPiece.col == col)
        {
            classes += " selected"; // Add the 'selected' class if the cell is selected
        }
        return classes;
    }
}
